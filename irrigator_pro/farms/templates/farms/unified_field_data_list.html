{% extends "base.html" %}

{% load today_filters %}
{% load day_records %}
{% load static %}
{% load mathfilters %}
{% block content %}

    <h1>
        
        <i class="fa fa-pencil-square-o fa-fw"> </i>
        
        Water Register and data entry for <input type="text" id="datepicker" 
                                                 onchange="dateChangedManually()"
                                                 name="report-date"
                                                 value='{{report_date |date:"Y-m-d" }}' 
                                                 style="width: 6em">
    </h1>
    
    <h2>
        <em>{{crop_season}}</em>
        - 
        <em>{{field}}</em>
        
        <button id="rows_option" 
                class="btn btn-success float-right"
                type="button" 
                style="margin-bottom: 10px">Show Entire Season</button>
        
    </h2>



    {% if object_list %}
        {{ wh_formset.id }}
        <form  id="unified_form" action="{{ request.path }}" method="post">{% csrf_token %}
            <table class="formset" >
                <thead>
                    <tr class="header1">
                        <th rowspan=2>Date</th>
                        <th rowspan=2>Source</th>
                        <th colspan=3>Soil Potential</th>
                        <th colspan=2>Soil Temperature</th>
                        <th colspan="2">Added Water</th>
                        <th rowspan="2">Action</th>
                        <th colspan="2">Crop</th>
                        <th rowspan="2">Average Water Content(AWC)</th>
                        <th rowspan="2">Recommendation</th>
                        <th rowspan="2">Message</th>
                        <th rowspan="2">Comment</th>
                        <th rowspan="2">Delete</th>
                    </tr>
                    <tr class="header2">
                        <th>8in</th>
                        <th>16in</th>
                        <th>24in</th>
                        <th>Min</th>
                        <th>Max</th>
                        <th>Rain</th>
                        <th>Irrigation</th>
                        <th>Stage</th>
                        <th>DWU</th>
                    </tr>
                </thead>

                <tbody>

                    {% for object in object_list %}

                        {% comment %}
                        Special case when there is no uga or manual reading. Can't ignore or delete.
                        {% endcomment %}

                        {% if object|day_records == 0 %}
                            <tr id="row-{{ object.date|date:"Y-m-d" }}"
                                {% if object.date|is_today  %}class="row-today" {% endif %}
                                {% if object.date|is_past   %}class="row-past"  {% endif %}
                                {% if object.date|is_future %}class="row-future"{% endif %}
                                                                                                                        >


                                <td>
                                    {{ object.date|date:"Y-m-d"}}
                                    {% comment %}
                                    If date is later than report date (usually today) then we don't
                                    allow adding manual entry forms.
                                    {% endcomment %}
                                    {% if not object.date|is_future %}
                                        <br>
                                        <button type="button" 
                                                onclick="addRow('row-{{ object.date|date:"Y-m-d" }}', '{{ object.date|date:"Y-m-d"}}', {{ crop_season.pk }})">
                                            <i class="fa fa-pencil-square-o"></i>
                                        </button>
                                    {% endif %}
                                </td>
                                <td>None</td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>

                                <td></td>

                                <td>{{ object.water_register.crop_stage }}</td>
                                <td>{{ object.water_register.daily_water_use }}</td>
                                <td>
	                            {% if object.water_register.computed_from_probes %}
		                        <i class="fa fa-rss"></i>
	                            {% endif %}
	                            {{ object.water_register.average_water_content|floatformat:2 }}
	                            {% if object.water_register.average_water_content <= 0.0 %}
		                        <img src="/static/img/svg/droplet_red.svg" height="14px" style="vertical-align:text-bottom;"/> 
	                            {% endif %}
                                </td>
                                <td class ="dti" rowspan="{{ rowspan }}">
	                            {% if object.water_register.irrigate_flag %}
		                        <div>
		                            <b>Irrigate Today</b>
		                            {% if object.water_register.average_water_content <= 0.0 %}
		                                AWC
		                            {% endif %}
		                            {% if object.water_register.max_temp_2in and object.water_register.max_temp_2in  < object.water_register.max_observed_temp_2in %}
		                                Temp
		                            {% endif %}
                                            
		                        </div>
		                    {% elif object.water_register.check_sensors_flag %}
		                        <div >
		                            {%if object.water_register.days_to_irrigation == 1 %}
		                                Irrigate Tomorrow
		                            {% else %}
		                                Irrigate in {{object.water_register.days_to_irrigation}} days
		                            {% endif %}
		                        </div>
		                    {% endif %}
		                    {% if object.water_register.dry_down_flag %}
		                        <div >
		                            Dry-Down
		                        </div>
		                    {% endif %}
                                </td>
                                
                                <td>{{ object.water_register.message }}</td>
                                
                                <td></td>
                                <td></td>
                            </tr>
                        {% else %}
                            {% for record in object.uga_records  %}
                                <tr id="row-{{ object.date|date:"Y-m-d" }}-{{ forloop.counter0 }}"
                                    {% if object.date|is_today  %}class="row-today" {% endif %}
                                    {% if object.date|is_past   %}class="row-past"  {% endif %}
                                    {% if object.date|is_future %}class="row-future"{% endif %}
                                    >

                                    {% if forloop.first %}

                                        {% comment %}
                                        First time around we need to add date and water register entries, with appropriate
                                        Column span
                                        {% endcomment %}
                                        

                                        {% with rowspan=object|day_records %}
                                            <td rowspan= "{{rowspan}}" >{{ object.date|date:"Y-m-d"}}<br>
                                                <button type="button" 
                                                        {% if object.forms %}
                                                        onclick="addRow('row-manual-{{ object.date|date:"Y-m-d" }}-{{ object.forms|length|sub:1 }}', '{{ object.date|date:"Y-m-d"}}', {{ crop_season.pk }})">
                                                        {% else %}
                                                    onclick="addRow('row-{{ object.date|date:"Y-m-d" }}', '{{ object.date|date:"Y-m-d"}}', {{ crop_season.pk }})">
                                                        {% endif %}

                                                        <i class="fa fa-pencil-square-o"></i>
                                                    </button>                                                
                                            </td>
                                            
                                            <td>{{record.source_type}}</td>
                                            <td>{{ record.soil_potential_8 }}</td>
                                            <td>{{ record.soil_potential_16 }}</td>
                                            <td>{{ record.soil_potential_24 }}</td>

                                            <td>{{ record.min_temp_24_hours }}</td>
                                            <td>{{ record.max_temp_24_hours }}</td>
                                            
                                            <td>{{ record.rain }}</td>
                                            <td>{{ record.irrigation }}</td>

                                            <td><input name="uga-{{ record.pk }}" 
                                                       type="checkbox"
                                                       {% if record.ignore %}checked{% endif %}>
                                            </td>
                                            
                                            <td rowspan="{{ rowspan }}">{{ object.water_register.crop_stage }}</td>
                                            <td rowspan="{{ rowspan }}">{{ object.water_register.daily_water_use }}</td>
                                            <td rowspan="{{ rowspan }}">
	                                        {% if object.water_register.computed_from_probes %}
		                                    <i class="fa fa-rss"></i>
	                                        {% endif %}
	                                        {{ object.water_register.average_water_content|floatformat:2 }}
	                                        {% if object.water_register.average_water_content <= 0.0 %}
		                                    <img src="/static/img/svg/droplet_red.svg" height="14px" style="vertical-align:text-bottom;"/> 
	                                        {% endif %}
                                            </td>

                                            <td class ="dti" rowspan="{{ rowspan }}">
	                                        {% if object.water_register.irrigate_flag %}
		                                    <div>
		                                        <b>Irrigate Today</b>
		                                        {% if object.water_register.average_water_content <= 0.0 %}
		                                            AWC
		                                        {% endif %}
		                                        {% if object.water_register.max_temp_2in and object.water_register.max_temp_2in  < object.water_register.max_observed_temp_2in %}
		                                            Temp
		                                        {% endif %}
                                                        
		                                    </div>
		                                {% elif object.water_register.check_sensors_flag %}
		                                    <div >
		                                        {%if object.water_register.days_to_irrigation == 1 %}
		                                            Irrigate Tomorrow
		                                        {% else %}
		                                            Irrigate in {{object.water_register.days_to_irrigation}} days
		                                        {% endif %}
		                                    </div>
		                                {% endif %}
		                                {% if object.water_register.dry_down_flag %}
		                                    <div >
		                                        Dry-Down
		                                    </div>
		                                {% endif %}
                                            </td>
                                            <td rowspan="{{ rowspan }}">{{ object.water_register.message }}</td>
                                            <td>{{ record.comment }}</td>
                                            <td></td>
                                            
                                        {% endwith %}
                                        
                                    {% else  %}
                                        {% comment %}
                                        Subsequent rows. Don't add computed entries or date. Most code duplicated from above
                                        Need a better way.
                                        {% endcomment %}
                                        
                                        <td>{{ record.source_type}}</td>
                                        <td>{{ record.soil_potential_8 }}</td>
                                        <td>{{ record.soil_potential_16 }}</td>
                                        <td>{{ record.soil_potential_24 }}</td>

                                        <td>{{ record.min_temp_24_hours }}</td>
                                        <td>{{ record.max_temp_24_hours }}</td>
                                        
                                        <td>{{ record.rain }}</td>
                                        <td>{{ record.irrigation }}</td>

                                        <td>{{ record.ignore }}</td>
                                        
                                        
                                    {% endif %}
                                </tr>
                            {% endfor %}
                            {% comment %}
                            Now add the forms
                            {% endcomment %}
                            {% for form in object.forms  %}

                                {% comment %}

                                List the water history records. If this is the
                                first for this date one AND there is no probe
                                readings then this is the first row for this
                                date in the table.

                                {% endcomment %}
                                <tr id="row-manual-{{ object.date|date:"Y-m-d" }}-{{ forloop.counter0 }}">
                                    {% with rowspan=object|day_records %}
                                        {% if forloop.first and object.uga_records|length == 0 %}
                                            <td rowspan= "{{rowspan}}" >{{ object.date|date:"Y-m-d"}}<br>
                                                <button type="button" 
                                                        onclick="addRow('row-manual-{{ object.date|date:"Y-m-d" }}-{{ object.forms|length|sub:1 }}', '{{ object.date|date:"Y-m-d"}}', {{ crop_season.pk }})">
                                                    <i class="fa fa-pencil-square-o"></i>

                                            </td>

                                        {% endif %}



  	                                {% for input in form %}
  	                                    {% if input.is_hidden %}
  		                                {{ input }}
                                            {% endif %}
                                        {% endfor %}


                                        <td>Manual Entry</td>
                                        <td>{{ form.soil_potential_8.error }}{{ form.soil_potential_8 }}</td>
                                        <td>{{ form.soil_potential_16.error }}{{ form.soil_potential_16 }}</td>
                                        <td>{{ form.soil_potential_24.error }}{{ form.soil_potential_24 }}</td>
                                        
                                        <td>{{ form.min_temp_24_hours.error }}{{ form.min_temp_24_hours }}</td>
                                        <td>{{ form.max_temp_24_hours.error }}{{ form.max_temp_24_hours }}</td>
                                    
                                        <td>{{ form.rain.error }}{{ form.rain }}</td>
                                        <td>{{ form.irrigation.error }}{{ form.irrigation }}</td>
                                        <td>{{ form.ignore }}</td>

                                        {% comment %}
                                        The exact same code is copied above. 
                                        {% endcomment %}
                                        
                                        {% if forloop.first and object.uga_records|length == 0 %}
                                            <td rowspan="{{ rowspan }}">{{ object.water_register.crop_stage }}</td>
                                            <td rowspan="{{ rowspan }}">{{ object.water_register.daily_water_use }}</td>
                                            <td rowspan="{{ rowspan }}">
                                                {% if object.water_register.computed_from_probes %}
		                                    <i class="fa fa-rss"></i>
	                                        {% endif %}
	                                        {{ object.water_register.average_water_content|floatformat:2 }}
	                                        {% if object.water_register.average_water_content <= 0.0 %}
		                                    <img src="/static/img/svg/droplet_red.svg" height="14px" style="vertical-align:text-bottom;"/> 
	                                        {% endif %}
                                            </td>
                                            <td class ="dti" rowspan="{{ rowspan }}">
	                                        {% if object.water_register.irrigate_flag %}
		                                    <div>
		                                        <b>Irrigate Today</b>
		                                        {% if object.water_register.average_water_content <= 0.0 %}
		                                            AWC
		                                        {% endif %}
		                                        {% if object.water_register.max_temp_2in and object.water_register.max_temp_2in  < object.water_register.max_observed_temp_2in %}
		                                            Temp
		                                        {% endif %}
                                                        
		                                    </div>
		                                {% elif object.water_register.check_sensors_flag %}
		                                    <div >
		                                        {%if object.water_register.days_to_irrigation == 1 %}
		                                            Irrigate Tomorrow
		                                        {% else %}
		                                            Irrigate in {{object.water_register.days_to_irrigation}} days
		                                        {% endif %}
		                                    </div>
		                                {% endif %}
		                                {% if object.water_register.dry_down_flag %}
		                                    <div >
		                                        Dry-Down
		                                    </div>
		                                {% endif %}
                                            </td>
                                            
                                            <td rowspan="{{ rowspan }}">{{ object.water_register.water_register.message }}</td>

                                        {% endif %}
                                        <td>{{ form.comment }}</td>
                                        <td>{{ form.DELETE }}</td>

                                    </tr>
                                {% endwith %}
                            {% endfor %}


                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
            <div class="submit-bar">
                <button value="Submit" type="submit" class="btn btn-success">
  	            <i class="fa fa-floppy-o"></i> Save Changes
                </button>        
  	        <a class="btn btn-warning" href="/settings/farm/">
  	            <i class="fa fa-undo fa-fw"></i> Cancel Changes
  	        </a>
            </div>
        
            {{ wh_formset.management_form }}
        </form>

    {% else %}
        {% if not crop_season.season_start_date <= report_date <= crop_season.season_end_date %}
            <div class="alert alert-danger">
                No data to display.  Today ({{report_date|date:'Y-m-d'}}) is outside the crop season period
                ({{crop_season.season_start_date|date:'Y-m-d'}} to {{crop_season.season_end_date|date:'Y-m-d'}}).
            </div>
        {% else %}    
            <div class="alert alert-danger">
                No data to display.
            </div>
        {% endif %}
    {% endif %}

{% endblock %}


{% block scripts %}

    {% if debug %}
        <script src="{{ STATIC_URL }}js/unified_field_data_list.js?t={% now "c" %}"></script>
    {% else %}
        <script src="{{ STATIC_URL }}js/unified_field_data_list.js"></script>
    {% endif %}
{% endblock %}

