{% extends "base.html" %}


{% block scripts %}
<script type="text/javascript">
    /* This function cleans up datepickers when a new formset row is added */
    function renewDatePickers() {
        /* Clear out old datepicker event handlers */
        $("input[id$=date]").datepicker('destroy');

        /* Remove buttons that got copied by formset.add */
        $("input[id$=date]").siblings("button").remove();

        /* 
           Re-activate date pickers, restricting dates to the range 
           specified by the crop season   
        */
        $("input[id$=date]").datepicker({ 
            minDate: '{{ season.season_start_date|date:"Y-m-d" }}',
            maxDate: '{{ season.season_end_date|date:"Y-m-d" }}',
        });
    }

    $(function() {
        /* Enable add row / delete row */
        $('#formset tbody tr').formset({
            addText: '<i class="iTooltip add-icon fa fa-plus-square" help="Add Row"> Add Row</i>',
            deleteText: '<i class="iTooltip delete-icon fa fa-minus-square" help="Delete Row"></i>',
            added: renewDatePickers,
            keepFieldValues: "input[type$=number]",
        })

       /*
          Instead of setting the minDate/maxDate separately, 
          reuse renewDatePickers code 
        */
       renewDatePickers();

    })
</script>
{% endblock %}


{% block content %}

  <h1>
    <i class="fa fa-cloud fa-fw"></i>
    Rainfall and Irrigation
  </h1>
 
    <h2>Season: <em>{{season}}</em>
      {% if field %}
        - Field: <em>{{ field }}</em>
      {% endif %}
    </h2>
  
    <form id="formset" action="{{ request.path }}" method="post">{% csrf_token %}
  
  
      {% if formset.non_form_errors %}
        {% for dict in formset.non_form_errors %}
          {% for key,value in dict.items %}
    	  <div class="alert alert-danger">
    	    {{ value }}
    	  </div>
          {% endfor %}
        {% endfor %}
      {% endif %}
  
  
      <table class="formset" >
  
        <thead>
  	<tr>
  	  <th>Date & Time</th>
  	  <th>Field</th>
  	  <th>Rain</th>
  	  <th>Irrigation</th>
  	  <th>Comment</th>
  	  <th>Delete</th>
  	</tr>
        </thead>
  
  
        <tbody>
  	{% for field in formset %}
  	  <tr>
  	    {% for input in field %}
  	      {% if not input.is_hidden %}
  		<td>
  		  {% if input.errors %}
  		    <div class="inline-alert alert-danger">
  		      {{ input.errors }}
  	            </div>
  		  {% endif %}
  		  {{ input }}
  		</td>
  	      {% else %}
  		{{ input }}
  	      {% endif %}
  	    {% endfor %}
  	  </tr>
  	{% endfor %}
  	</table>
  
  
      <div class="submit-bar">
        <button value="Submit" type="submit" class="btn btn-success">
  	<i class="fa fa-floppy-o"></i> Save Changes
        </button>
  
  
        {% if object.pk %}
  	<a class="btn btn-warning" href="{% url 'farm_list' %}{{ object.pk }}">
  	  <i class="fa fa-undo fa-fw"></i> Cancel Changes
  	</a>
        {% else %}
  	<a class="btn btn-warning" href="{% url 'farm_list' %}">
  	  <i class="fa fa-undo fa-fw"></i> Cancel Changes
  	</a>
        {% endif %}
  
        {% if object.pk %}
  	<a class="btn btn-danger" href="{% url 'farm_list' %}delete/{{ object.pk }}">
  	  <i class="fa fa-times fa-fw"></i> Delete
  	</a>
        {% endif %}
  
      </div>
  
  
      {{ formset.management_form }}
  
    </form>

{% endblock %}
